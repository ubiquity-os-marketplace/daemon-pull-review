name: "@ubiquity-os-marketplace/daemon-pull-review"
description: "Autoamtically reviews pull requests on issues that are ready for review"

inputs:
  stateId:
    description: "State Id"
  eventName:
    description: "Event Name"
  eventPayload:
    description: "Event Payload"
  settings:
    description: "Settings"
  authToken:
    description: "Auth Token"
  ref:
    description: "Ref"
  signature:
    description: "Signature sent from the Kernel"
  command:
    description: "Command"

outputs:
  result:
    description: "The review of the pull request"
    value: ${{ steps.main.outputs.result }}

runs:
  using: "composite"
  steps:
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20.10.0"

    - uses: oven-sh/setup-bun@v2

    - name: Install dependencies
      shell: bash
      run: |
        bun install --frozen-lockfile

    - name: Get GitHub App token
      if: env.APP_ID != '' && env.APP_PRIVATE_KEY != ''
      uses: tibdex/github-app-token@v1.7.0
      id: get_installation_token
      with:
        app_id: ${{ env.APP_ID }}
        private_key: ${{ env.APP_PRIVATE_KEY }}

    - name: Install dependencies for GitHub Auth
      shell: bash
      run: |
        bun add "@actions/github" glob

    - name: Run compute reviews
      id: main
      run: |
        node dist/index.js
      env:
        GH_TOKEN: ${{ steps.get_installation_token.outputs.token }}
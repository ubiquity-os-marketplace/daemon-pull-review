name: "Pull Request Reviewer"

on:
  workflow_dispatch:
    inputs:
      stateId:
        description: "State Id"
      eventName:
        description: "Event Name"
      eventPayload:
        description: "Event Payload"
      settings:
        description: "Settings"
      authToken:
        description: "Auth Token"
      ref:
        description: "Ref"
      signature:
        description: "Signature sent from the Kernel"
      command:
        description: "Command"

jobs:
  compute:
    name: "Pull review"
    runs-on: ubuntu-latest
    permissions: write-all
    environment: ${{ github.ref == 'refs/heads/main' && 'main' || 'development' }}

    steps:
      - name: Decompress event payload
        uses: ubiquity-os/compress-action@main
        id: eventPayload
        with:
          data: ${{ inputs.eventPayload }}
          mode: decompress

      - uses: actions/checkout@v5
        with:
          token: ${{ inputs.authToken }}
          repository: ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.full_name }}
          ref: refs/pull/${{ fromJson(steps.eventPayload.outputs.result).pull_request.number }}/merge
          fetch-depth: 0
          persist-credentials: false

      - name: Make Codex config and setup Github MCP tools
        run: |
          mkdir -p ~/.codex
          echo "[mcp_servers.github]" >> ~/.codex/config.toml
          echo "url = \"https://api.githubcopilot.com/mcp\"" >> ~/.codex/config.toml
          echo "bearer_token_env_var = \"GITHUB_MCP_TOKEN\"" >> ~/.codex/config.toml
          echo "http_headers = { \"X-MCP-Toolsets\" = \"repos,issues,pull_requests,users\", \"X-MCP-Readonly\" = \"true\" }" >> ~/.codex/config.toml

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        env:
          GITHUB_MCP_TOKEN: ${{ inputs.authToken }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          allow-bots: true
          prompt: |
            This is PR #${{ fromJson(steps.eventPayload.outputs.result).pull_request.number }} for ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.full_name }}.

            Review ONLY the changes introduced by the PR, so consider:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Suggest any improvements, potential bugs, or issues.
            Be concise and specific in your feedback.
            Check if the PR implements the requirements from each linked issue. You can also check issue's comments for additional context.
            Use Github MCP tools to get more context about the repository, issues, and PRs if needed.
            Use Git CLI to analyze the changes introduced by the PR.

            Pull request title and body:
            ----
            ${{ fromJson(steps.eventPayload.outputs.result).pull_request.title }}
            ${{ fromJson(steps.eventPayload.outputs.result).pull_request.body }}

      - name: Echo Codex Output
        run: echo "${{ steps.run_codex.outputs.final-message }}"

name: "Pull Request Reviewer"

on:
  workflow_dispatch:
    inputs:
      stateId:
        description: "State Id"
      eventName:
        description: "Event Name"
      eventPayload:
        description: "Event Payload"
      settings:
        description: "Settings"
      authToken:
        description: "Auth Token"
      ref:
        description: "Ref"
      signature:
        description: "Signature sent from the Kernel"
      command:
        description: "Command"

jobs:
  compute:
    name: "Pull review"
    runs-on: ubuntu-latest
    permissions: write-all
    environment: ${{ github.ref == 'refs/heads/main' && 'main' || 'development' }}
    if: ${{ inputs.eventName == 'pull_request' }}

    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ inputs.authToken }}
          repository: ${{ fromJson(inputs.eventPayload).pull_request.base.repo.full_name }}
          ref: ${{ 'pull/' || fromJson(inputs.eventPayload).pull_request.number || '/merge' }}
          persist-credentials: false

      - name: Run Claude Code Review
        id: claude-review
        uses: ubiquity-whilefoo/claude-code-action@custom-event
        env:
          CUSTOM_EVENT_PAYLOAD: ${{ inputs.eventPayload }}
          CUSTOM_EVENT_NAME: ${{ inputs.eventName }}
        with:
          github_token: ${{ inputs.authToken }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          model: "claude-sonnet-4-20250514"

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Be constructive and helpful in your feedback.

name: "Pull Request Reviewer"

on:
  workflow_dispatch:
    inputs:
      stateId:
        description: "State Id"
      eventName:
        description: "Event Name"
      eventPayload:
        description: "Event Payload"
      settings:
        description: "Settings"
      authToken:
        description: "Auth Token"
      ref:
        description: "Ref"
      signature:
        description: "Signature sent from the Kernel"
      command:
        description: "Command"

jobs:
  compute:
    name: "Pull review"
    runs-on: ubuntu-latest
    permissions: write-all
    environment: ${{ github.ref == 'refs/heads/main' && 'main' || 'development' }}

    steps:
      - name: Decompress event payload
        uses: ubiquity-os/compress-action@main
        id: eventPayload
        with:
          data: ${{ inputs.eventPayload }}
          mode: decompress

      - name: Checkout daemon-pull-review
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          path: daemon

      - name: Checkout target repository
        uses: actions/checkout@v5
        with:
          token: ${{ inputs.authToken }}
          repository: ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.full_name }}
          ref: refs/pull/${{ fromJson(steps.eventPayload.outputs.result).pull_request.number }}/merge
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        working-directory: daemon
        run: bun install

      - name: Prepare prompt
        id: prepare_prompt
        working-directory: daemon
        env:
          GITHUB_TOKEN: ${{ inputs.authToken }}
          EVENT_PAYLOAD: ${{ steps.eventPayload.outputs.result }}
        run: |
          bun run scripts/prompt.ts

      - name: Run Codex
        id: run_codex
        uses: ubiquity-os/codex-action@chatgpt-auth
        if: steps.prepare_prompt.outputs.should_skip != 'true'
        env:
          GITHUB_MCP_TOKEN: ${{ inputs.authToken }}
        with:
          codex-auth-config: ${{ secrets.CODEX_AUTH_CONFIG }}
          codex-config: |
            approval_policy = "never"
            [mcp_servers.github]
            url = "https://api.githubcopilot.com/mcp"
            bearer_token_env_var = "GITHUB_MCP_TOKEN"
            http_headers = { "X-MCP-Toolsets" = "repos,issues,pull_requests,users", "X-MCP-Readonly" = "true" }
          event-payload: ${{ steps.eventPayload.outputs.result }}
          auth-token: ${{ inputs.authToken }}
          model: ${{ vars.CODEX_MODEL_NAME || '' }}
          effort: ${{ vars.CODEX_EFFORT || '' }}
          sandbox: "workspace-write"
          safety-strategy: "drop-sudo"
          allow-bots: true
          prompt: ${{ steps.prepare_prompt.outputs.prompt }}

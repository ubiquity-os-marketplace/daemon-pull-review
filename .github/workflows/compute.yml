name: "Pull Request Reviewer"

on:
  workflow_dispatch:
    inputs:
      stateId:
        description: "State Id"
      eventName:
        description: "Event Name"
      eventPayload:
        description: "Event Payload"
      settings:
        description: "Settings"
      authToken:
        description: "Auth Token"
      ref:
        description: "Ref"
      signature:
        description: "Signature sent from the Kernel"
      command:
        description: "Command"

jobs:
  compute:
    name: "Pull review"
    runs-on: ubuntu-latest
    permissions: write-all
    environment: ${{ github.ref == 'refs/heads/main' && 'main' || 'development' }}

    steps:
      - name: Save event payload
        run: echo '${{ github.event.inputs.eventPayload }}' > $RUNNER_TEMP/github_event.json

      - name: Output github context in JS
        uses: actions/github-script@v7
        env:
          GITHUB_EVENT_PATH: ${{ runner.temp }}/github_event.json
          GITHUB_EVENT_NAME: ${{ github.event.inputs.eventName }}
          GITHUB_REPOSITORY: ${{ toJson(github.event.inputs.eventPayload).repository.full_name }}
        with:
          script: console.log(context.eventName)

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        env:
          GITHUB_EVENT_PATH: ${{ runner.temp }}/github_event.json
          GITHUB_EVENT_NAME: ${{ github.event.inputs.eventName }}
          GITHUB_REPOSITORY: ${{ toJson(github.event.inputs.eventPayload).repository.full_name }}
        with:
          github_token: ${{ github.event.inputs.authToken }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          model: "claude-sonnet-4-20250514"

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Be constructive and helpful in your feedback.

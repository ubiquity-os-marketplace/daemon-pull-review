name: "Pull Request Reviewer"

on:
  workflow_dispatch:
    inputs:
      stateId:
        description: "State Id"
      eventName:
        description: "Event Name"
      eventPayload:
        description: "Event Payload"
      settings:
        description: "Settings"
      authToken:
        description: "Auth Token"
      ref:
        description: "Ref"
      signature:
        description: "Signature sent from the Kernel"
      command:
        description: "Command"

jobs:
  compute:
    name: "Pull review"
    runs-on: ubuntu-latest
    permissions: write-all
    environment: ${{ github.ref == 'refs/heads/main' && 'main' || 'development' }}

    steps:
      - name: Decompress event payload
        uses: ubiquity-os/compress-action@main
        id: eventPayload
        with:
          data: ${{ inputs.eventPayload }}
          mode: decompress

      - uses: actions/checkout@v5
        with:
          token: ${{ inputs.authToken }}
          repository: ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.full_name }}
          ref: refs/pull/${{ fromJson(steps.eventPayload.outputs.result).pull_request.number }}/merge
          fetch-depth: 0
          persist-credentials: false

      - name: Create Codex config and setup MCP tools
        env:
          CODEX_AUTH_CONFIG: ${{ secrets.CODEX_AUTH_CONFIG }}
        run: |
          mkdir -p ~/.codex
          echo "$CODEX_AUTH_CONFIG" > ~/.codex/auth.json
          cat <<EOF > ~/.codex/config.toml
          approval_policy = "never"
          [mcp_servers.github]
          url = "https://api.githubcopilot.com/mcp"
          bearer_token_env_var = "GITHUB_MCP_TOKEN"
          http_headers = { "X-MCP-Toolsets" = "repos,issues,pull_requests,users", "X-MCP-Readonly" = "true" }
          EOF

      - name: Post Thinking comment
        uses: actions/github-script@v8
        id: post_thinking
        env:
          GITHUB_TOKEN: ${{ inputs.authToken }}
          OWNER: ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.owner.login }}
          REPO: ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.name }}
          PR_NUMBER: ${{ fromJson(steps.eventPayload.outputs.result).pull_request.number }}
        with:
          github-token: ${{ inputs.authToken }}
          script: |
            const response = await github.rest.issues.createComment({
              owner: process.env.OWNER,
              repo: process.env.REPO,
              issue_number: parseInt(process.env.PR_NUMBER),
              body: `UbiquityOS is workingâ€¦ <img src="https://github.com/user-attachments/assets/5ac382c7-e004-429b-8e35-7feb3e8f9c6f" width="14px" height="14px" style="vertical-align: middle; margin-left: 4px;" />

            I'll analyze this and get back to you.`,
            });
            return response.data.id;

      - name: Run Codex
        id: run_codex
        uses: ubiquity-whilefoo/codex-action@chatgpt-auth
        env:
          GITHUB_MCP_TOKEN: ${{ inputs.authToken }}
        with:
          model: ${{ vars.CODEX_MODEL_NAME || '' }}
          effort: ${{ vars.CODEX_EFFORT || '' }}
          sandbox: "workspace-write"
          safety-strategy: "drop-sudo"
          allow-bots: true
          prompt: |
            This is PR #${{ fromJson(steps.eventPayload.outputs.result).pull_request.number }} for ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.full_name }}.

            Review ONLY the changes introduced by the PR, so consider:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Suggest any improvements, potential bugs, or issues.
            Be concise and specific in your feedback.
            Check if the PR implements the requirements from each linked issue. You can also check issue's comments for additional context.
            Use Github MCP tools to get more context about the repository, issues, and PRs if needed.
            Use Git CLI to analyze the changes introduced by the PR.

            Pull request title and body:
            ----
            ${{ fromJson(steps.eventPayload.outputs.result).pull_request.title }}
            ${{ fromJson(steps.eventPayload.outputs.result).pull_request.body }}

      - name: Post comment
        uses: actions/github-script@v8
        env:
          GITHUB_TOKEN: ${{ inputs.authToken }}
          CODEX_OUTPUT: ${{ steps.run_codex.outputs.final-message }}
          OWNER: ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.owner.login }}
          REPO: ${{ fromJson(steps.eventPayload.outputs.result).pull_request.base.repo.name }}
          GITHUB_COMMENT_ID: ${{ steps.post_thinking.outputs.result }}
        with:
          github-token: ${{ inputs.authToken }}
          script: |
            await github.rest.issues.updateComment({
              owner: process.env.OWNER,
              repo: process.env.REPO,
              comment_id: parseInt(process.env.GITHUB_COMMENT_ID),
              body: process.env.CODEX_OUTPUT,
            });
